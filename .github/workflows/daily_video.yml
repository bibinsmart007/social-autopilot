# .github/workflows/daily_video.yml
#
# Variable posting schedule (UAE time ‚Üí UTC):
#   Mon  8AM ‚Üí 04:00 UTC
#   Tue 12PM ‚Üí 08:00 UTC
#   Wed  6PM ‚Üí 14:00 UTC
#   Thu  9AM ‚Üí 05:00 UTC
#   Fri  1PM ‚Üí 09:00 UTC
#   Sat 10AM ‚Üí 06:00 UTC
#   Sun  5PM ‚Üí 13:00 UTC

name: Daily Social Video

on:
  schedule:
    - cron: "0 4 * * 1"    # Monday    4 AM UTC  = 8 AM UAE
    - cron: "0 8 * * 2"    # Tuesday   8 AM UTC  = 12 PM UAE
    - cron: "0 14 * * 3"   # Wednesday 2 PM UTC  = 6 PM UAE
    - cron: "0 5 * * 4"    # Thursday  5 AM UTC  = 9 AM UAE
    - cron: "0 9 * * 5"    # Friday    9 AM UTC  = 1 PM UAE
    - cron: "0 6 * * 6"    # Saturday  6 AM UTC  = 10 AM UAE
    - cron: "0 13 * * 0"   # Sunday    1 PM UTC  = 5 PM UAE

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (generate video but don't post)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: üì• Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: üêç Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: üì¶ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg fonts-dejavu-core

      - name: üì¶ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: üé® Download font and BGM assets
        run: |
          mkdir -p fonts bgm fallback_clips

          # ‚îÄ‚îÄ Montserrat Bold font ‚îÄ‚îÄ
          if [ ! -f fonts/Montserrat-Bold.ttf ]; then
            echo "üì• Downloading Montserrat-Bold.ttf..."
            curl -sL --retry 3 --retry-delay 2 \
              "https://github.com/JulietaUla/Montserrat/raw/master/fonts/ttf/Montserrat-Bold.ttf" \
              -o fonts/Montserrat-Bold.ttf

            # Validate ‚Äî real TTF is at least ~50KB
            if [ -f fonts/Montserrat-Bold.ttf ] && [ "$(wc -c < fonts/Montserrat-Bold.ttf)" -gt 10000 ]; then
              echo "‚úÖ Montserrat-Bold.ttf downloaded ($(wc -c < fonts/Montserrat-Bold.ttf) bytes)"
            else
              echo "‚ö†Ô∏è  Font download may have failed ‚Äî will use system fallback"
              rm -f fonts/Montserrat-Bold.ttf
            fi
          else
            echo "‚úÖ Montserrat-Bold.ttf already exists"
          fi

          # ‚îÄ‚îÄ BGM tracks from Pixabay CDN (royalty-free, no attribution required) ‚îÄ‚îÄ
          # Only download if bgm/ has fewer than 1 valid MP3
          BGM_COUNT=$(find bgm/ -name "*.mp3" -size +10k 2>/dev/null | wc -l)
          if [ "$BGM_COUNT" -lt 1 ]; then
            echo "üì• Downloading BGM tracks from Pixabay..."

            # Track 1: Upbeat motivational (health & wealth content)
            curl -sL --retry 3 --retry-delay 2 --max-time 60 \
              "https://cdn.pixabay.com/audio/2024/11/28/audio_3a42e68da3.mp3" \
              -o bgm/bgm_01_upbeat.mp3

            # Track 2: Calm ambient (mental wellbeing content)
            curl -sL --retry 3 --retry-delay 2 --max-time 60 \
              "https://cdn.pixabay.com/audio/2024/09/11/audio_d0e93db165.mp3" \
              -o bgm/bgm_02_calm.mp3

            # Track 3: Inspiring corporate (business & ecommerce content)
            curl -sL --retry 3 --retry-delay 2 --max-time 60 \
              "https://cdn.pixabay.com/audio/2024/10/30/audio_39e96d80c6.mp3" \
              -o bgm/bgm_03_inspiring.mp3

            # Track 4: Soft piano (versatile, all niches)
            curl -sL --retry 3 --retry-delay 2 --max-time 60 \
              "https://cdn.pixabay.com/audio/2024/08/27/audio_4e1efe7e3f.mp3" \
              -o bgm/bgm_04_piano.mp3

            # Track 5: Energetic electronic (listicle & tips style)
            curl -sL --retry 3 --retry-delay 2 --max-time 60 \
              "https://cdn.pixabay.com/audio/2024/10/08/audio_6414efbc7c.mp3" \
              -o bgm/bgm_05_energetic.mp3

            # Validate ‚Äî remove anything under 10KB (broken downloads)
            for f in bgm/bgm_*.mp3; do
              if [ -f "$f" ]; then
                SIZE=$(wc -c < "$f")
                if [ "$SIZE" -lt 10000 ]; then
                  echo "‚ö†Ô∏è  Removing invalid BGM: $f ($SIZE bytes)"
                  rm -f "$f"
                else
                  echo "‚úÖ $(basename "$f") ‚Äî $(( SIZE / 1024 )) KB"
                fi
              fi
            done

            FINAL_COUNT=$(find bgm/ -name "*.mp3" -size +10k 2>/dev/null | wc -l)
            echo "üìä BGM tracks ready: $FINAL_COUNT"
            if [ "$FINAL_COUNT" -lt 1 ]; then
              echo "‚ö†Ô∏è  No BGM downloaded ‚Äî video will use voiceover only (still works fine)"
            fi
          else
            echo "‚úÖ BGM folder already has $BGM_COUNT track(s)"
          fi

      - name: üìÇ Create directories
        run: |
          mkdir -p temp/clips output data scripts_archive

      - name: üöÄ Run pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          AYRSHARE_API_KEY: ${{ secrets.AYRSHARE_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          python main.py

      - name: üíæ Commit updated data files
        if: always()
        run: |
          git config user.name "Social AutoPilot Bot"
          git config user.email "bot@autopilot.local"
          git add data/ scripts_archive/ || true
          git diff --cached --quiet || git commit -m "üìä Update data [skip ci]"
          git push || echo "Push failed"

      - name: üìé Upload video artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ github.run_number }}
          path: output/final_video.mp4
          retention-days: 7
