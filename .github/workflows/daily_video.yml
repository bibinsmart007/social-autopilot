# .github/workflows/daily_video.yml
#
# Variable posting schedule (UAE time â†’ UTC):
#   Mon  8AM â†’ 04:00 UTC
#   Tue 12PM â†’ 08:00 UTC
#   Wed  6PM â†’ 14:00 UTC
#   Thu  9AM â†’ 05:00 UTC
#   Fri  1PM â†’ 09:00 UTC
#   Sat 10AM â†’ 06:00 UTC
#   Sun  5PM â†’ 13:00 UTC
#
# We schedule the workflow to run at ALL these times,
# then a gate step checks if today matches the current cron slot.

name: Daily Social Video

on:
  schedule:
    - cron: "0 4 * * 1"    # Monday    4 AM UTC  = 8 AM UAE
    - cron: "0 8 * * 2"    # Tuesday   8 AM UTC  = 12 PM UAE
    - cron: "0 14 * * 3"   # Wednesday 2 PM UTC  = 6 PM UAE
    - cron: "0 5 * * 4"    # Thursday  5 AM UTC  = 9 AM UAE
    - cron: "0 9 * * 5"    # Friday    9 AM UTC  = 1 PM UAE
    - cron: "0 6 * * 6"    # Saturday  6 AM UTC  = 10 AM UAE
    - cron: "0 13 * * 0"   # Sunday    1 PM UTC  = 5 PM UAE

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: "Dry run (generate video but don't post)"
        required: false
        default: "false"
        type: choice
        options:
          - "false"
          - "true"

jobs:
  generate-and-post:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: ğŸ Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: ğŸ“¦ Install system dependencies
        run: |
          sudo apt-get update -qq
          sudo apt-get install -y -qq ffmpeg fonts-dejavu-core

      - name: ğŸ“¦ Install Python dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: ğŸ“‚ Create directories
        run: |
          mkdir -p temp/clips output data scripts_archive

      - name: ğŸš€ Run pipeline
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          PEXELS_API_KEY: ${{ secrets.PEXELS_API_KEY }}
          AYRSHARE_API_KEY: ${{ secrets.AYRSHARE_API_KEY }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          DRY_RUN: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          python main.py

      - name: ğŸ’¾ Commit updated data files
        if: always()
        run: |
          git config user.name "Social AutoPilot Bot"
          git config user.email "bot@autopilot.local"
          git add data/ scripts_archive/ || true
          git diff --cached --quiet || git commit -m "ğŸ“Š Update data [skip ci]"
          git push || echo "Push failed"

      - name: ğŸ“ Upload video artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: video-${{ github.run_number }}
          path: output/final_video.mp4
          retention-days: 7
